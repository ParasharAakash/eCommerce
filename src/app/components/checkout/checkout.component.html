<ng-container *ngIf="!purchaseSuccess">
  <div class="form-row mt-5">
    <div class="offset-sm-2">
      <h2>Shipping Address</h2>
    </div>
  </div>
  <div *ngIf="_authService.loggedIn() && loggedUser" class="row p-5">
    <div class="col-md-6">
      <form
        (ngSubmit)="updateUserInfo()"
        *ngIf="loggedUser"
        #formData="ngForm"
        class="needs-validation"
        novalidate
      >
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="first_name" class="asterisk-label">First name</label>
            <input
              type="text"
              required
              class="form-control"
              name="loggedUser.first_name"
              [(ngModel)]="loggedUser.first_name"
              #first_name="ngModel"
            />
          </div>
          <div class="form-group col-md-4">
            <label for="last_name" class="asterisk-label">Last name</label>
            <input
              type="text"
              required
              class="form-control"
              name="loggedUser.last_name"
              [(ngModel)]="loggedUser.last_name"
              #last_name="ngModel"
            />
          </div>
          <div class="form-group col-md-4">
            <label for="email" class="asterisk-label">Email</label>
            <input
              type="email"
              required
              pattern="^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$"
              [class.is-invalid]="email.dirty && email.invalid"
              class="form-control"
              name="loggedUser.local.email"
              [(ngModel)]="loggedUser.local.email"
              #email="ngModel"
            />
            <div class="invalid-feedback">
              Must be a valid email
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="address1" class="asterisk-label">Address 1</label>
          <input
            type="text"
            required
            class="form-control"
            name="loggedUser.address.street1"
            [(ngModel)]="loggedUser.address.street1"
            #street="ngModel"
          />
        </div>
        <div class="form-group">
          <label for="address2">Address 2</label>
          <input
            type="text"
            class="form-control"
            name="loggedUser.address.street2"
            [(ngModel)]="loggedUser.address.street2"
            #street2="ngModel"
          />
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="city" class="asterisk-label">City</label>
            <input
              type="text"
              required
              class="form-control"
              name="loggedUser.address.city"
              [(ngModel)]="loggedUser.address.city"
              #city="ngModel"
            />
          </div>
          <div class="form-group col-md-4">
            <label for="state" class="asterisk-label">State</label>
            <select
              class="form-control"
              required
              name="loggedUser.address.state"
              [(ngModel)]="loggedUser.address.state"
              #state="ngModel"
            >
              <option value="" selected disabled hidden
                >--Choose state--</option
              >
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="DC">District Of Columbia</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
          </div>
          <div class="form-group col-md-2">
            <label for="inputZip" class="asterisk-label">Zip</label>
            <input
              type="text"
              required
              minlength="5"
              class="form-control"
              [class.is-invalid]="zip.dirty && zip.invalid"
              pattern="^\d{5}(?:[-\s]\d{4})?$"
              name="loggedUser.address.zip"
              [(ngModel)]="loggedUser.address.zip"
              #zip="ngModel"
            />
            <div class="invalid-tooltip">
              Must be a valid zip code
            </div>
          </div>
        </div>
        <button
          *ngIf="formData.valid && address"
          type="submit"
          class="btn btn-secondary mt-2"
          data-toggle="modal"
          data-target="#confirmationModal"
        >
          Process purchase
        </button>
        <div class="row justify-content-between">
          <div class="col-lg-8 col-sm-8 text-nowrap">
            <button
              [disabled]="formData.invalid"
              type="submit"
              class="btn btn-info btn-lg"
              data-toggle="modal"
              data-target=".processPurchase"
            >
              Confirm shipping information
            </button>
          </div>
          <div class="col-lg-4 col-sm-12">
            <button
              id="cancel-btn"
              type="button"
              class="btn btn-outline-secondary btn-lg"
              [routerLink]="['/cartify/products']"
            >
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="offset-md-2 col-md-4">
      <div class="card border-info mb-3">
        <div id="card-header-summary" class="card-header bg-transparent">
          <div class="row justify-content-between">
            <div class="col-auto">
              <h4>Order summary</h4>
            </div>
            <div class="col-auto">
              <a [routerLink]="['/cartify/cart']" class="float-right"
                >View cart</a
              >
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row justify-content-between mb-3">
            <div class="col-auto">
              <strong><h5 class="card-text">Subtotal</h5></strong>
            </div>
            <div class="col-auto">
              <h5 class="card-text float-right">${{ cart?.totalPrice }}.00</h5>
            </div>
          </div>
          <div class="row justify-content-between">
            <div class="col-auto">
              <h5 class="card-text">Tax</h5>
            </div>
            <div class="col-auto">
              <h5 class="card-text float-right">${{ tax }}</h5>
            </div>
          </div>
        </div>
        <div id="card-footer-summary" class="card-footer bg-transparent">
          <div class="row justify-content-between">
            <div class="col-auto">
              <strong><h4>Total</h4></strong>
            </div>
            <div class="col-auto">
              <strong
                ><h5 class="card-text float-right">${{ totalSum }}</h5></strong
              >
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <button
            id="keep-shopping-btn"
            [routerLink]="['/cartify/products']"
            class="btn btn-info btn-lg"
          >
            <i class="fas fa-chevron-left"></i> Back to shopping
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div
    class="modal fade processPurchase"
    tabindex="-1"
    role="dialog"
    aria-labelledby="mySmallModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header justify-content-end">
          <h4 class="modal-title pl-5">
            Great!!! One more step!
          </h4>
          <button
            id="close-btn"
            type="button"
            class="close"
            data-dismiss="modal"
          >
            <span id="close-icon" aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <div class="row  justify-content-between">
            <div class="col text-nowrap">
              <button (click)="pay(totalSum)" class="btn btn-secondary mt-2">
                Process purchase
              </button>
            </div>
            <div class="col">
              <button class="btn btn-secondary mt-2" data-dismiss="modal">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>
<app-success-purchase
  *ngIf="purchaseSuccess"
  [orderData]="cart"
  [cartItems]="cartItems"
  [totalPayment]="totalSum"
  [salesTax]="actualTax"
></app-success-purchase>
